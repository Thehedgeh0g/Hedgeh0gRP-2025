<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Summary</title>
    <script src="https://cdn.jsdelivr.net/npm/centrifuge@5.3.0/dist/centrifuge.min.js"></script>
</head>
<body>
<h2>Evaluation Summary</h2>
<div id="result">
    <p><strong>Channel:</strong> <span id="channel">loading...</span></p>
    <p><strong>Rank:</strong> <span id="rank">-</span></p>
    <p><strong>Similarity:</strong> <span id="similarity">-</span></p>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");

    const token = localStorage.getItem("token");
    if (!token) {
        alert("Please login first.");
        window.location.href = "/login";
    }

    // 1. Получаем начальные данные через API
    fetch("/api/summary-data?id=" + id, {
        headers: { Authorization: "Bearer " + token }
    })
        .then(res => res.json())
        .then(data => {
            const { channel, rank, similarity, centrifugoToken } = data;

            document.getElementById("channel").textContent = channel;
            document.getElementById("rank").textContent = rank;
            document.getElementById("similarity").textContent = similarity ? "Yes" : "No";

            // 2. Подключаемся к Centrifugo
            const centrifuge = new Centrifuge("ws://localhost:8000/connection/websocket", {
                token: centrifugoToken,
                name: "web-client"
            });

            const sub = centrifuge.newSubscription(channel);

            sub.on("publication", function (ctx) {
                const pub = ctx.data;
                if (typeof pub.rank !== "undefined") {
                    document.getElementById("rank").textContent = pub.rank;
                }
                if (typeof pub.similarity !== "undefined") {
                    document.getElementById("similarity").textContent = pub.similarity ? "Yes" : "No";
                }
            });

            sub.subscribe();
            centrifuge.connect();
        })
        .catch(err => {
            console.error("Error loading summary:", err);
            document.getElementById("result").innerHTML = "Failed to load summary.";
        });
</script>
</body>
</html>
